<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Presupuestador Standalone (Logo + Tema)</title>
<style>
  :root{
    --bg:#0b0d10;
    --panel:#141821;
    --panel-2:#0f131a;
    --text:#e7eef9;
    --muted:#a9b5c7;
    --primary:#4ea1ff;
    --accent:#7bd88f;
    --danger:#ff6363;
    --border:#232a36;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
    background:var(--bg);
    color:var(--text);
  }
  .container{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;gap:16px;flex-wrap:wrap;align-items:end;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:48px;width:auto;border-radius:8px;border:1px solid var(--border);background:#fff;object-fit:contain}
  h1{margin:0;font-size:24px}
  p.lead{margin:0;color:var(--muted);font-size:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel-2);color:var(--text);cursor:pointer}
  .btn:hover{border-color:#2f3746;transform:translateY(-1px)}
  .btn.danger{background:#2a1416;border-color:#50252a;color:#ffd4d4}
  .btn.secondary{background:#12161d}
  .btn.icon{padding:8px 9px}
  .row{display:grid;gap:12px}
  @media(min-width:900px){.row-3{grid-template-columns:2fr 1fr 1fr}.row-2{grid-template-columns:1fr 1fr}.row-4{grid-template-columns:repeat(4,1fr)}}
  .card{background:linear-gradient(180deg, var(--panel), var(--panel-2));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 20px rgba(0,0,0,.2)}
  .card h2{margin:0 0 8px 0;font-size:16px}
  .card .content{padding:16px}
  .card .head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input, textarea, select{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
    background:var(--panel-2);color:var(--text);outline:none
  }
  input:focus, textarea:focus{border-color:#3a4456}
  input[type="color"]{height:40px;padding:0;border-radius:8px}
  table{width:100%;border-collapse:collapse}
  th, td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;vertical-align:top}
  thead th{position:sticky;top:0;background:var(--panel);z-index:1}
  .muted{color:var(--muted)}
  .right{text-align:right}
  .nowrap{white-space:nowrap}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
  .totals .rowline{display:flex;justify-content:space-between;margin:6px 0}
  .totals .strong{font-weight:700}
  .totals .big{font-size:18px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:16px}
  .tab{padding:10px 14px;border:1px solid var(--border);border-bottom:none;border-radius:12px 12px 0 0;background:var(--panel-2);cursor:pointer}
  .tab.active{background:var(--panel);color:#fff}
  .hidden{display:none}
  .table-scroll{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px}
  footer{opacity:.8;text-align:center;margin-top:16px;font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; background:#0a0d13;border:1px solid #1d2431;border-bottom-color:#131824;border-radius:6px;padding:0px 6px}
  @media print{
    .no-print{display:none !important}
    body{background:white;color:black}
    .card{background:white;border-color:#ddd;box-shadow:none}
    thead th{background:white}
    .pill{border-color:#aaa;color:#444}
    .brand img{height:40px;border-color:#ccc}
  }
</style>
</head>
<body>
<div class="container">
  <header class="no-print">
    <div class="brand">
      <img id="brandLogo" alt="Logo" src="" onerror="this.style.display='none'">
      <div>
        <h1>Presupuestador</h1>
        <p class="lead">Cat√°logo de partidas y presupuesto r√°pido con % beneficio, portes, descuento e IVA.</p>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btnPrint">üñ® Imprimir</button>
      <button class="btn" id="btnDuplicate">üß¨ Duplicar</button>
      <button class="btn" id="btnExport">‚¨áÔ∏è Exportar</button>
      <label class="btn" for="fileImport" style="gap:6px">‚¨ÜÔ∏è Importar<input id="fileImport" type="file" accept="application/json" style="display:none"></label>
      <button class="btn danger" id="btnReset">üóë Vaciar</button>
    </div>
  </header>

  <div class="tabs no-print">
    <div class="tab active" data-tab="presupuesto">Presupuesto</div>
    <div class="tab" data-tab="catalogo">Cat√°logo</div>
    <div class="tab" data-tab="ajustes">Ajustes</div>
    <div class="pill">Logo y colores se guardan</div>
  </div>

  <!-- Presupuesto -->
  <section id="presupuesto" class="tabpane">
    <div class="row row-3">
      <div class="card" style="grid-column: span 2">
        <div class="head">
          <h2>Presupuesto actual</h2>
          <div class="muted" id="rowsCount"></div>
        </div>
        <div class="content">
          <div class="row row-3">
            <div>
              <label>T√≠tulo</label><input id="bdgTitle" placeholder="Reforma Vivienda ‚Äî Cliente X">
            </div>
            <div>
              <label>Fecha</label><input id="bdgDate" type="date">
            </div>
            <div>
              <label>Cap√≠tulo</label><input id="bdgChapter" placeholder="General">
            </div>
          </div>

          <div class="table-scroll" style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th>Cap.</th>
                  <th>C√≥digo</th>
                  <th>Partida</th>
                  <th>Ud</th>
                  <th>Cant.</th>
                  <th>P. unit.</th>
                  <th class="right">Importe</th>
                  <th class="no-print"></th>
                </tr>
              </thead>
              <tbody id="tbodyBudget">
                <tr><td colspan="8" class="muted" style="text-align:center;padding:20px">A√±ade partidas desde el cat√°logo</td></tr>
              </tbody>
            </table>
          </div>

          <div class="row row-4" style="margin-top:12px">
            <div>
              <label>% Descuento</label><input id="pctDesc" type="number" step="0.01">
            </div>
            <div>
              <label>% Beneficio</label><input id="pctBen" type="number" step="0.01">
            </div>
            <div>
              <label>% Portes</label><input id="pctPort" type="number" step="0.01">
            </div>
            <div>
              <label>% IVA</label>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="pctIva" type="number" step="0.01">
                <label style="display:flex;align-items:center;gap:6px;user-select:none"><input type="checkbox" id="chkIva"> Aplicar</label>
              </div>
            </div>
          </div>

          <div class="row row-2" style="margin-top:12px">
            <div class="card">
              <div class="content totals" id="totalsBox"></div>
            </div>
            <div class="card">
              <div class="content">
                <label>Observaciones</label>
                <textarea id="notes" rows="6" placeholder="Plazo de ejecuci√≥n, condiciones, forma de pago, etc."></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <h2>Cat√°logo</h2>
          <div class="toolbar no-print">
            <button class="btn" id="btnAddPart">‚ûï Nueva</button>
          </div>
        </div>
        <div class="content">
          <div class="row row-2">
            <div>
              <label>Buscar</label><input id="query" placeholder="C√≥digo, nombre, cap√≠tulo...">
            </div>
            <div>
              <label>Filtrar por cap√≠tulo</label>
              <select id="filterChapter"></select>
            </div>
          </div>

          <div class="table-scroll" style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th>Cap√≠tulo</th>
                  <th>C√≥digo</th>
                  <th>Partida</th>
                  <th>Ud</th>
                  <th>P. unit.</th>
                  <th class="right no-print">A√±adir</th>
                </tr>
              </thead>
              <tbody id="tbodyCatalog"></tbody>
            </table>
          </div>
          <div class="muted" id="chaptersInfo" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Cat√°logo Standalone -->
  <section id="catalogo" class="tabpane hidden">
    <div class="card">
      <div class="head"><h2>Gesti√≥n del cat√°logo</h2><button class="btn no-print" id="btnAddPart2">‚ûï A√±adir partida</button></div>
      <div class="content">
        <div class="row row-2">
          <div><label>Buscar</label><input id="query2" placeholder="C√≥digo, nombre, cap√≠tulo..."></div>
          <div><label>Cap√≠tulo</label><input id="chapterDefault" placeholder="General"></div>
        </div>
        <div class="table-scroll" style="margin-top:12px">
          <table>
            <thead>
              <tr><th>Cap√≠tulo</th><th>C√≥digo</th><th>Nombre</th><th>Ud</th><th>P. unit.</th><th class="right no-print">Acciones</th></tr>
            </thead>
            <tbody id="tbodyCatalog2"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Ajustes -->
  <section id="ajustes" class="tabpane hidden">
    <div class="card">
      <div class="head"><h2>Preferencias</h2></div>
      <div class="content">
        <div class="row row-3">
          <div><label>Moneda</label><input id="currency"></div>
          <div><label>Decimales</label><input id="decimals" type="number"></div>
          <div><label>Cap√≠tulo por defecto</label><input id="chapterPref" placeholder="General"></div>
        </div>

        <div class="row row-3" style="margin-top:12px">
          <div><label>Color de fondo (‚Äîbg)</label><input type="color" id="colorBg"></div>
          <div><label>Panel principal (‚Äîpanel)</label><input type="color" id="colorPanel"></div>
          <div><label>Panel secundario (‚Äîpanel-2)</label><input type="color" id="colorPanel2"></div>
        </div>
        <div class="row row-3" style="margin-top:12px">
          <div><label>Texto (‚Äîtext)</label><input type="color" id="colorText"></div>
          <div><label>Primario (‚Äîprimary)</label><input type="color" id="colorPrimary"></div>
          <div><label>Borde (‚Äîborder)</label><input type="color" id="colorBorder"></div>
        </div>

        <div class="row row-2" style="margin-top:12px">
          <div>
            <label>Logo (URL)</label>
            <input id="logoUrl" placeholder="https://.../logo.png">
          </div>
          <div>
            <label>Datos de la empresa (opcional)</label>
            <textarea id="firm" rows="6" placeholder="Nombre fiscal, CIF, direcci√≥n"></textarea>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="no-print">Consejo: ajusta los colores en Ajustes ‚Üí Preferencias. El logo se muestra arriba y en impresi√≥n.</footer>

</div>

<script>
(function(){
  const LS = {
    CATALOG: "presu.catalog.v1",
    BUDGET: "presu.budget.v1",
    SETTINGS: "presu.settings.v1",
    THEME: "presu.theme.v1"
  };

  const uid = () => Math.random().toString(36).slice(2,10);
  const today = () => new Date().toISOString().slice(0,10);
  const parseNum = (v) => { const x = parseFloat(String(v).replace(',', '.')); return isFinite(x) ? x : 0; };
  const fmt = (n, c, d) => (new Intl.NumberFormat(undefined,{minimumFractionDigits:d, maximumFractionDigits:d})).format(+n||0) + ' ' + c;

  const defaultSettings = { currency:'‚Ç¨', showIva:true, ivaPct:21, benefitPct:10, shippingPct:0, descuentoPct:0, redondeo:2, firm:'', logoUrl:'' };
  const defaultTheme = {
    bg:'#0b0d10', panel:'#141821', panel2:'#0f131a', text:'#e7eef9',
    primary:'#4ea1ff', accent:'#7bd88f', danger:'#ff6363', border:'#232a36'
  };
  const sampleCatalog = () => [
    { id: uid(), chapter:'Demoliciones', code:'DEM-001', name:'Demolici√≥n de tabique de ladrillo hueco', unit:'m¬≤', price:18.5, notes:'Incluye gesti√≥n de escombros'},
    { id: uid(), chapter:'Alba√±iler√≠a', code:'ALB-010', name:'Tabique de ladrillo cer√°mico 7cm + enlucido', unit:'m¬≤', price:34.2, notes:'Suministro y colocaci√≥n'},
    { id: uid(), chapter:'Carpinter√≠a', code:'CAR-120', name:'Puerta maciza en DM lacado, herrajes incluidos', unit:'ud', price:185.0, notes:'Altura est√°ndar'},
    { id: uid(), chapter:'Instalaciones', code:'ELE-050', name:'Punto de luz y mecanismo empotrado', unit:'ud', price:42.0, notes:'Canalizaci√≥n y cableado'},
    { id: uid(), chapter:'Pintura', code:'PIN-030', name:'Pintura pl√°stica mate lavable, 2 manos', unit:'m¬≤', price:6.8, notes:'Color a elegir'},
  ];
  const emptyBudget = () => ({ id:uid(), title:'Nuevo presupuesto', date:today(), chapter:'General', items:[], notes:'', client:'', firm:'' });

  let catalog = JSON.parse(localStorage.getItem(LS.CATALOG) || 'null') || sampleCatalog();
  let budget  = JSON.parse(localStorage.getItem(LS.BUDGET)  || 'null') || emptyBudget();
  let settings= { ...defaultSettings, ...(JSON.parse(localStorage.getItem(LS.SETTINGS) || 'null')||{}) };
  let theme   = { ...defaultTheme, ...(JSON.parse(localStorage.getItem(LS.THEME) || 'null')||{}) };
  let q1='', q2='', filterChapter = '';

  const el = (id) => document.getElementById(id);
  const setThemeVars = ()=>{
    const r = document.documentElement;
    r.style.setProperty('--bg', theme.bg);
    r.style.setProperty('--panel', theme.panel);
    r.style.setProperty('--panel-2', theme.panel2);
    r.style.setProperty('--text', theme.text);
    r.style.setProperty('--primary', theme.primary);
    r.style.setProperty('--border', theme.border);
  };
  setThemeVars();

  // Tabs
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.querySelectorAll('.tabpane').forEach(p=>p.classList.add('hidden'));
      el(t.dataset.tab).classList.remove('hidden');
    });
  });

  // Header buttons
  el('btnPrint').onclick = ()=> window.print();
  el('btnDuplicate').onclick = ()=> { budget = { ...budget, id:uid(), title: budget.title + ' (copia)', date: today() }; saveAll(); renderAll(); };
  el('btnExport').onclick = ()=> {
    const payload = { catalog, budget, settings, theme, version:2 };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'presupuesto_'+ new Date().toISOString().slice(0,19) + '.json';
    a.click(); URL.revokeObjectURL(url);
  };
  el('fileImport').onchange = (ev)=>{
    const file = ev.target.files?.[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(data.catalog && data.budget && data.settings){
          catalog = data.catalog; budget = data.budget; settings = { ...settings, ...data.settings };
          if(data.theme) theme = { ...theme, ...data.theme };
          saveAll(); renderAll();
        } else alert('Archivo no reconocido');
      }catch{ alert('No se pudo leer el JSON'); }
    };
    reader.readAsText(file);
  };
  el('btnReset').onclick = ()=>{
    if(!confirm('¬øVaciar el presupuesto actual?')) return;
    budget = emptyBudget(); saveBudget(); renderBudget(); renderTotals();
  };

  // Inputs Presupuesto
  el('bdgTitle').oninput = (e)=>{ budget.title = e.target.value; saveBudget(); };
  el('bdgDate').oninput  = (e)=>{ budget.date  = e.target.value; saveBudget(); };
  el('bdgChapter').oninput=(e)=>{ budget.chapter = e.target.value; saveBudget(); renderCatalog(); };

  // Percentages
  el('pctDesc').oninput = (e)=>{ settings.descuentoPct = parseNum(e.target.value); saveSettings(); renderTotals(); };
  el('pctBen').oninput  = (e)=>{ settings.benefitPct   = parseNum(e.target.value); saveSettings(); renderTotals(); };
  el('pctPort').oninput = (e)=>{ settings.shippingPct  = parseNum(e.target.value); saveSettings(); renderTotals(); };
  el('pctIva').oninput  = (e)=>{ settings.ivaPct       = parseNum(e.target.value); saveSettings(); renderTotals(); };
  el('chkIva').onchange = (e)=>{ settings.showIva      = e.target.checked; saveSettings(); renderTotals(); };
  el('notes').oninput   = (e)=>{ budget.notes          = e.target.value; saveBudget(); };

  // Catalog filters
  el('query').oninput = (e)=>{ q1 = e.target.value.toLowerCase(); renderCatalog(); };
  el('query2').oninput= (e)=>{ q2 = e.target.value.toLowerCase(); renderCatalog2(); };
  el('filterChapter').onchange = (e)=>{ filterChapter = e.target.value; renderCatalog(); };

  // Catalog add buttons
  el('btnAddPart').onclick = addPart;
  el('btnAddPart2').onclick = addPart;

  // Ajustes
  el('currency').oninput = (e)=>{ settings.currency = e.target.value; saveSettings(); renderTotals(); renderCatalog(); renderBudget(); };
  el('decimals').oninput = (e)=>{ settings.redondeo = parseInt(e.target.value||'0',10)||0; saveSettings(); renderTotals(); renderBudget(); };
  el('chapterPref').oninput=(e)=>{ budget.chapter = e.target.value; saveBudget(); renderCatalog(); };
  el('firm').oninput = (e)=>{ settings.firm = e.target.value; saveSettings(); };
  el('logoUrl').oninput = (e)=>{ settings.logoUrl = e.target.value.trim(); saveSettings(); renderLogo(); };

  // Theme inputs
  const themeBindings = [
    ['colorBg','bg'], ['colorPanel','panel'], ['colorPanel2','panel2'],
    ['colorText','text'], ['colorPrimary','primary'], ['colorBorder','border']
  ];
  themeBindings.forEach(([id,key])=>{
    el(id).oninput = (e)=>{ theme[key] = e.target.value; saveTheme(); setThemeVars(); };
  });

  // Keyboard save
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveAll(); }
  });

  function saveCatalog(){ localStorage.setItem(LS.CATALOG, JSON.stringify(catalog)); }
  function saveBudget(){ localStorage.setItem(LS.BUDGET, JSON.stringify(budget)); }
  function saveSettings(){ localStorage.setItem(LS.SETTINGS, JSON.stringify(settings)); }
  function saveTheme(){ localStorage.setItem(LS.THEME, JSON.stringify(theme)); }
  function saveAll(){ saveCatalog(); saveBudget(); saveSettings(); saveTheme(); }

  function addPart(){
    const p = { id:uid(), chapter: budget.chapter || 'General', code:'', name:'Nueva partida', unit:'ud', price:0, notes:'' };
    catalog = [p, ...catalog]; saveCatalog(); renderCatalog(); renderCatalog2();
  }

  function removePart(id){
    if(!confirm('¬øEliminar esta partida del cat√°logo?')) return;
    catalog = catalog.filter(x=>x.id!==id); saveCatalog(); renderCatalog(); renderCatalog2();
  }

  function addToBudget(partId){
    const exists = budget.items.find(i=>i.partId===partId);
    if(exists){ exists.qty += 1; }
    else { budget.items.push({ id:uid(), partId, qty:1, overridePrice:null, notes:'' }); }
    saveBudget(); renderBudget(); renderTotals();
  }

  function removeBudgetItem(itemId){
    budget.items = budget.items.filter(i=>i.id!==itemId);
    saveBudget(); renderBudget(); renderTotals();
  }

  function chapterList(){
    const set = new Set(catalog.map(p=>p.chapter).filter(Boolean));
    return ['(todos)', ...Array.from(set).sort()];
  }

  function filtered(cat, query, chapter){
    const q = (query||'').trim().toLowerCase();
    return cat.filter(p=>{
      const hay = [p.code, p.name, p.unit, p.notes||'', p.chapter||''].join(' ').toLowerCase();
      const matchText = !q || hay.includes(q);
      const matchChapter = !chapter || chapter==='(todos)' || p.chapter===chapter;
      return matchText && matchChapter;
    });
  }

  function currentRows(){
    return budget.items.map(it=>({ ...it, part: catalog.find(p=>p.id===it.partId) })).filter(r=>r.part);
  }

  function totals(){
    const rows = currentRows();
    const subtotal = rows.reduce((s,r)=> s + r.qty * (r.overridePrice==null ? r.part.price : r.overridePrice), 0);
    const descuento = subtotal * (settings.descuentoPct||0) / 100;
    const baseTrasDto = subtotal - descuento;
    const beneficio = baseTrasDto * (settings.benefitPct||0) / 100;
    const portes    = baseTrasDto * (settings.shippingPct||0) / 100;
    const baseImp   = baseTrasDto + beneficio + portes;
    const iva       = settings.showIva ? baseImp * (settings.ivaPct||0) / 100 : 0;
    const total     = baseImp + iva;
    return { subtotal, descuento, baseTrasDto, beneficio, portes, baseImp, iva, total };
  }

  function renderBudget(){
    el('bdgTitle').value = budget.title||'';
    el('bdgDate').value  = budget.date||today();
    el('bdgChapter').value = budget.chapter||'General';
    el('notes').value = budget.notes||'';

    const tbody = el('tbodyBudget'); tbody.innerHTML = '';
    const rows = currentRows();
    el('rowsCount').textContent = rows.length ? rows.length+' partidas' : 'Sin partidas';
    if(rows.length===0){
      const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan=8;
      td.className='muted'; td.style.textAlign='center'; td.style.padding='20px'; td.textContent='A√±ade partidas desde el cat√°logo';
      tr.appendChild(td); tbody.appendChild(tr);
    } else {
      rows.forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.part.chapter||''}</td>
          <td>${row.part.code||''}</td>
          <td>${row.part.name||''}</td>
          <td>${row.part.unit||''}</td>
          <td class="nowrap"><input type="number" step="0.01" value="${row.qty}" style="width:90px"></td>
          <td class="nowrap"><input type="number" step="0.01" value="${row.overridePrice==null? row.part.price : row.overridePrice}" style="width:120px"></td>
          <td class="right strong"></td>
          <td class="right no-print"><button class="btn icon">üóë</button></td>
        `;
        const [qtyInput, priceInput] = [tr.querySelectorAll('input')[0], tr.querySelectorAll('input')[1]];
        const totalCell = tr.children[6];
        const updateRowTotal = ()=> totalCell.textContent = fmt(row.qty * (row.overridePrice==null? row.part.price : row.overridePrice), settings.currency, settings.redondeo);
        updateRowTotal();
        qtyInput.oninput = (e)=>{ row.qty = parseNum(e.target.value); const it = budget.items.find(i=>i.id===row.id); if(it){it.qty=row.qty;} saveBudget(); renderTotals(); updateRowTotal(); };
        priceInput.oninput = (e)=>{ row.overridePrice = parseNum(e.target.value); const it = budget.items.find(i=>i.id===row.id); if(it){it.overridePrice=row.overridePrice;} saveBudget(); renderTotals(); updateRowTotal(); };
        tr.querySelector('button').onclick = ()=> removeBudgetItem(row.id);
        tbody.appendChild(tr);
      });
    }
  }

  function renderCatalog(){
    const sel = el('filterChapter'); sel.innerHTML = '';
    chapterList().forEach(ch=>{
      const o = document.createElement('option'); o.value = ch; o.textContent = ch; sel.appendChild(o);
    });
    if(!filterChapter) filterChapter = '(todos)';
    sel.value = filterChapter;

    const tbody = el('tbodyCatalog'); tbody.innerHTML='';
    const list = filtered(catalog, q1, filterChapter);
    list.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="editable" contenteditable="true" data-field="chapter">${p.chapter||''}</span></td>
        <td><span class="editable" contenteditable="true" data-field="code">${p.code||''}</span></td>
        <td>
          <div><span class="editable" contenteditable="true" data-field="name">${p.name||''}</span></div>
          <div class="muted" style="font-size:12px"><span class="editable" contenteditable="true" data-field="notes">${p.notes||''}</span></div>
        </td>
        <td><span class="editable" contenteditable="true" data-field="unit">${p.unit||''}</span></td>
        <td><input type="number" step="0.01" value="${p.price}" style="width:120px"></td>
        <td class="right no-print">
          <button class="btn">‚ûï A√±adir</button>
          <button class="btn icon">üóë</button>
        </td>
      `;
      tr.querySelectorAll('.editable').forEach(span=>{
        span.addEventListener('blur', ()=>{
          const field = span.dataset.field; p[field] = span.textContent.trim(); saveCatalog(); renderCatalog(); renderCatalog2();
        });
      });
      tr.querySelector('input').oninput = (e)=>{ p.price = parseNum(e.target.value); saveCatalog(); };
      const [btnAdd, btnDel] = tr.querySelectorAll('button');
      btnAdd.onclick = ()=> addToBudget(p.id);
      btnDel.onclick = ()=> removePart(p.id);
      tbody.appendChild(tr);
    });

    el('chaptersInfo').textContent = 'Cap√≠tulos disponibles: ' + (Array.from(new Set(catalog.map(x=>x.chapter))).sort().join(', ') || '(ninguno)');
  }

  function renderCatalog2(){
    el('chapterDefault').value = budget.chapter||'General';
    const tbody = el('tbodyCatalog2'); tbody.innerHTML='';
    const list = filtered(catalog, q2, '');
    list.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="editable" contenteditable="true" data-field="chapter">${p.chapter||''}</span></td>
        <td><span class="editable" contenteditable="true" data-field="code">${p.code||''}</span></td>
        <td><span class="editable" contenteditable="true" data-field="name">${p.name||''}</span></td>
        <td><span class="editable" contenteditable="true" data-field="unit">${p.unit||''}</span></td>
        <td><input type="number" step="0.01" value="${p.price}" style="width:120px"></td>
        <td class="right no-print"><button class="btn icon">üóë</button></td>
      `;
      tr.querySelectorAll('.editable').forEach(span=>{
        span.addEventListener('blur', ()=>{ const f=span.dataset.field; p[f]=span.textContent.trim(); saveCatalog(); renderCatalog(); renderCatalog2(); });
      });
      tr.querySelector('input').oninput = (e)=>{ p.price = parseNum(e.target.value); saveCatalog(); };
      tr.querySelector('button').onclick = ()=> removePart(p.id);
      tbody.appendChild(tr);
    });
  }

  function renderTotals(){
    const {subtotal, descuento, baseTrasDto, beneficio, portes, baseImp, iva, total} = totals();
    const c = settings.currency, d = settings.redondeo;
    const box = el('totalsBox');
    box.innerHTML = `
      <div class="rowline"><div class="muted">Subtotal</div><div>${fmt(subtotal,c,d)}</div></div>
      <div class="rowline"><div class="muted">Descuento (${settings.descuentoPct||0}%)</div><div>-${fmt(descuento,c,d)}</div></div>
      <div class="rowline"><div class="muted">Beneficio (${settings.benefitPct||0}%)</div><div>${fmt(beneficio,c,d)}</div></div>
      <div class="rowline"><div class="muted">Portes (${settings.shippingPct||0}%)</div><div>${fmt(portes,c,d)}</div></div>
      <hr style="border:none;border-top:1px solid var(--border)">
      <div class="rowline strong"><div>Base imponible</div><div>${fmt(baseImp,c,d)}</div></div>
      ${ settings.showIva ? `<div class="rowline"><div class="muted">IVA (${settings.ivaPct||0}%)</div><div>${fmt(iva,c,d)}</div></div>` : '' }
      <hr style="border:none;border-top:1px solid var(--border)">
      <div class="rowline strong big"><div>TOTAL</div><div>${fmt(total,c,d)}</div></div>
    `;
  }

  function renderAjustes(){
    el('currency').value = settings.currency||'‚Ç¨';
    el('decimals').value = settings.redondeo||2;
    el('chapterPref').value = budget.chapter||'General';
    el('firm').value = settings.firm||'';
    el('logoUrl').value = settings.logoUrl||'';
    el('colorBg').value = theme.bg;
    el('colorPanel').value = theme.panel;
    el('colorPanel2').value = theme.panel2;
    el('colorText').value = theme.text;
    el('colorPrimary').value = theme.primary;
    el('colorBorder').value = theme.border;
    renderLogo();
  }

  function renderLogo(){
    const img = document.getElementById('brandLogo');
    if(settings.logoUrl && settings.logoUrl.trim()){
      img.src = settings.logoUrl.trim();
      img.style.display = 'block';
    } else {
      img.removeAttribute('src');
      img.style.display = 'none';
    }
  }

  function renderAll(){
    renderBudget(); renderCatalog(); renderCatalog2(); renderTotals(); renderAjustes();
    el('pctDesc').value = settings.descuentoPct||0;
    el('pctBen').value = settings.benefitPct||0;
    el('pctPort').value = settings.shippingPct||0;
    el('pctIva').value = settings.ivaPct||21;
    el('chkIva').checked = !!settings.showIva;
  }

  renderAll();
})();
</script>
</body>
</html>